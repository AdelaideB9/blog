<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Substitution - ångstromCTF 2021 | AdelaideB9 Blog</title><meta name=keywords content><meta name=description content="A write up for the ångstromCTF crypto challenge substitution "><meta name=author content="lachlan"><link rel=canonical href=https://blog.adelaideb9.com/posts/2021/angstromctf/substitution/><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.adelaideb9.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.adelaideb9.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.adelaideb9.com/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.adelaideb9.com/apple-touch-icon.png><link rel=mask-icon href=https://blog.adelaideb9.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous onload='renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})'></script><meta property="og:title" content="Substitution - ångstromCTF 2021"><meta property="og:description" content="A write up for the ångstromCTF crypto challenge substitution "><meta property="og:type" content="article"><meta property="og:url" content="https://blog.adelaideb9.com/posts/2021/angstromctf/substitution/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-08T13:12:52+00:00"><meta property="article:modified_time" content="2021-04-08T13:12:52+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Substitution - ångstromCTF 2021"><meta name=twitter:description content="A write up for the ångstromCTF crypto challenge substitution "><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.adelaideb9.com/posts/"},{"@type":"ListItem","position":2,"name":"Substitution - ångstromCTF 2021","item":"https://blog.adelaideb9.com/posts/2021/angstromctf/substitution/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Substitution - ångstromCTF 2021","name":"Substitution - ångstromCTF 2021","description":"A write up for the ångstromCTF crypto challenge substitution ","keywords":[],"articleBody":"For this challenge we are given a source file and a netcat server which presumably runs the source. Looking through the source code, we see that a integer is taken in as input and using this input, the flag is encrypted. The source is as follows:\n#!/usr/bin/python from functools import reduce with open(\"flag\", \"r\") as f: key = [ord(x) for x in f.read().strip()] def substitute(value): return (reduce(lambda x, y: x*value+y, key)) % 691 print(\"Enter a number and it will be returned with our super secret synthetic substitution technique\") while True: try: value = input(\"\u003e \") if value == 'quit': quit() value = int(value) enc = substitute(value) print(\"\u003e\u003e \", end=\"\") print(enc) except ValueError: print(\"Invalid input. \") The main function of interest to us is the substitute function.\ndef substitute(value): return (reduce(lambda x, y: x*value+y, key)) % 691 After researching what the reduce function does, we see that we are essentially recursively calling\n$$f(x,y) = kx+y$$\nwhere $k$ is the user input, $x$ is the previous result and $y$ is the next character in the flag. As $f$ is a linear function, we can produce the following linear equation.\n$$g(k) \\equiv x_0 k^{n-1}+x_1 k^{n-2}+…+x_{n-2} k+x_{n-1} \\pmod{691}$$\nwhere $x_n$ is the $n$th character of the flag. To test our understanding, let us evaluate $g(0)$. As per $g(k)$, we should have $g(0)=x_{n-1}$. In other words, we should get the last letter of the flag, hence we should get the ASCII value of }. Connecting to the server and trying it, we indeed get $125$.\nKnowing this, we can make a $n \\times n$ linear system where the $n$th equation is the equation $g(n)$.\n$$\\begin{aligned}g(0) \u0026\\equiv x_0 \\times 0^{n-1}+ x_1 \\times 0^{n-2}+ … +x_{n-2} \\times 0+x{n-1} \\pmod{691} \\\\ g(1) \u0026\\equiv x_0 \\times 1^{n-1}+ x_1 \\times 1^{n-2}+ … +x_{n-2} \\times 1+x_{n-1} \\pmod{691} \\\\ g(2) \u0026\\equiv x_0 \\times 2^{n-1}+ x_1 \\times 2^{n-2}+ … +x_{n-2} \\times 2+x_{n-1} \\pmod{691} \\end{aligned}$$\nThis can be expressed as:\n$$A\\textbf{X}=\\textbf{B} \\pmod{691}$$\nwhere A is the coefficient matrix:\n$$\\begin{bmatrix}0^{n-1} \u0026 0^{n-2} \u0026 \\cdots \u0026 0^{1} \u0026 1 \\\\ 1^{n-1} \u0026 1^{n-2} \u0026 \\cdots \u0026 1^{1} \u0026 1 \\\\ \\vdots \u0026 \\vdots \u0026 \\ddots \u0026 \\vdots \u0026 \\vdots \\\\ (n-2)^{n-1} \u0026 (n-2)^{n-2} \u0026 \\cdots \u0026 (n-2)^{1} \u0026 1 \\\\ (n-1)^{n-1} \u0026 (n-1)^{n-2} \u0026 \\cdots \u0026 (n-1)^{1} \u0026 1\\end{bmatrix}$$\nand B is the outputs for each given input:\n$$\\begin{bmatrix}g(0) \\\\ g(1) \\\\ \\vdots \\\\ g(n-2) \\\\ g(n-1) \\end{bmatrix}$$\nand $X$ is the matrix of characters (essentially the flag).\nWhile we are not sure as to how long the flag will be, it is reasonable to say it will be less that 100 characters (based off previously retrieved flags). Using this equation and the fact that the characters must be integers, we can solve the system over $\\mathbb{Z}\\pmod{691}$. This can be done with the following sage maths script that uses pwntools to connect to the server and collect the results.\nfrom pwn import * import re # Connecting with pwntools nc = remote('crypto.2021.chall.actf.co', 21601) nc.recvline() nums = [] for i in range(100): # Sending the numbers from 0-99 to the server and listening to the response nc.sendline(str(i)) res = str(nc.recvline()) # Stripping the number from the response and appending it to numbers nums.append(int(re.findall(\"[0-9]+\", res)[0])) # Using sagemaths to solve the linear system M = matrix(ZZ, 100, 100, lambda x, y: pow(x, 99-y)) b = vector(GF(691), 100, nums) solution = M.solve_right(b) # Converting the solution into a string flag = ''.join(chr(c) for c in solution) print(flag) Sure enough, after a minute or so of running, we get the flag!\nactf{polynomials_20a829322766642530cf69}\n","wordCount":"582","inLanguage":"en","datePublished":"2021-04-08T13:12:52.939Z","dateModified":"2021-04-08T13:12:52.939Z","author":{"@type":"Person","name":"lachlan"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.adelaideb9.com/posts/2021/angstromctf/substitution/"},"publisher":{"@type":"Organization","name":"AdelaideB9 Blog","logo":{"@type":"ImageObject","url":"https://blog.adelaideb9.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.adelaideb9.com/ accesskey=h title="AdelaideB9 Blog (Alt + H)">AdelaideB9 Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.adelaideb9.com/archives/ title=Archive><span>Archive</span></a></li><li><a href=https://blog.adelaideb9.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://blog.adelaideb9.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.adelaideb9.com/>Home</a>&nbsp;»&nbsp;<a href=https://blog.adelaideb9.com/posts/>Posts</a></div><h1 class=post-title>Substitution - ångstromCTF 2021</h1><div class=post-description>A write up for the ångstromCTF crypto challenge substitution</div><div class=post-meta><span title='2021-04-08 13:12:52.939 +0000 UTC'>April 8, 2021</span>&nbsp;·&nbsp;lachlan</div></header><div class=post-content><p>For this challenge we are given a source file and a netcat server which presumably runs the source. Looking through the source code, we see that a integer is taken in as input and using this input, the flag is encrypted. The source is as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/python</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> functools <span style=color:#f92672>import</span> reduce
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;flag&#34;</span>, <span style=color:#e6db74>&#34;r&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    key <span style=color:#f92672>=</span> [ord(x) <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> f<span style=color:#f92672>.</span>read()<span style=color:#f92672>.</span>strip()]
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>substitute</span>(value):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (reduce(<span style=color:#66d9ef>lambda</span> x, y: x<span style=color:#f92672>*</span>value<span style=color:#f92672>+</span>y, key)) <span style=color:#f92672>%</span> <span style=color:#ae81ff>691</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(<span style=color:#e6db74>&#34;Enter a number and it will be returned with our super secret synthetic substitution technique&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        value <span style=color:#f92672>=</span> input(<span style=color:#e6db74>&#34;&gt; &#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> value <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;quit&#39;</span>:
</span></span><span style=display:flex><span>            quit()
</span></span><span style=display:flex><span>        value <span style=color:#f92672>=</span> int(value)
</span></span><span style=display:flex><span>        enc <span style=color:#f92672>=</span> substitute(value)
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;&gt;&gt; &#34;</span>, end<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>)
</span></span><span style=display:flex><span>        print(enc)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>ValueError</span>:
</span></span><span style=display:flex><span>        print(<span style=color:#e6db74>&#34;Invalid input. &#34;</span>)
</span></span></code></pre></div><p>The main function of interest to us is the substitute function.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>substitute</span>(value):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> (reduce(<span style=color:#66d9ef>lambda</span> x, y: x<span style=color:#f92672>*</span>value<span style=color:#f92672>+</span>y, key)) <span style=color:#f92672>%</span> <span style=color:#ae81ff>691</span>
</span></span></code></pre></div><p>After researching what the reduce function does, we see that we are essentially recursively calling</p><p>$$f(x,y) = kx+y$$</p><p>where $k$ is the user input, $x$ is the previous result and $y$ is the next character in the flag. As $f$ is a linear function, we can produce the following linear equation.</p><p>$$g(k) \equiv x_0 k^{n-1}+x_1 k^{n-2}+&mldr;+x_{n-2} k+x_{n-1} \pmod{691}$$</p><p>where $x_n$ is the $n$th character of the flag. To test our understanding, let us evaluate $g(0)$. As per $g(k)$, we should have $g(0)=x_{n-1}$. In other words, we should get the last letter of the flag, hence we should get the ASCII value of <em>}</em>. Connecting to the server and trying it, we indeed get $125$.</p><p>Knowing this, we can make a $n \times n$ linear system where the $n$th equation is the equation $g(n)$.</p><p>$$\begin{aligned}g(0) &\equiv x_0 \times 0^{n-1}+ x_1 \times 0^{n-2}+ &mldr; +x_{n-2} \times 0+x{n-1} \pmod{691} \\ g(1) &\equiv x_0 \times 1^{n-1}+ x_1 \times 1^{n-2}+ &mldr; +x_{n-2} \times 1+x_{n-1} \pmod{691} \\ g(2) &\equiv x_0 \times 2^{n-1}+ x_1 \times 2^{n-2}+ &mldr; +x_{n-2} \times 2+x_{n-1} \pmod{691} \end{aligned}$$</p><p>This can be expressed as:</p><p>$$A\textbf{X}=\textbf{B} \pmod{691}$$</p><p>where A is the coefficient matrix:</p><p>$$\begin{bmatrix}0^{n-1} & 0^{n-2} & \cdots & 0^{1} & 1 \\ 1^{n-1} & 1^{n-2} & \cdots & 1^{1} & 1 \\ \vdots & \vdots & \ddots & \vdots & \vdots \\ (n-2)^{n-1} & (n-2)^{n-2} & \cdots & (n-2)^{1} & 1 \\ (n-1)^{n-1} & (n-1)^{n-2} & \cdots & (n-1)^{1} & 1\end{bmatrix}$$</p><p>and B is the outputs for each given input:</p><p>$$\begin{bmatrix}g(0) \\ g(1) \\ \vdots \\ g(n-2) \\ g(n-1) \end{bmatrix}$$</p><p>and $X$ is the matrix of characters (essentially the flag).</p><p>While we are not sure as to how long the flag will be, it is reasonable to say it will be less that 100 characters (based off previously retrieved flags). Using this equation and the fact that the characters must be integers, we can solve the system over $\mathbb{Z}\pmod{691}$. This can be done with the following sage maths script that uses <em>pwntools</em> to connect to the server and collect the results.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> re
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Connecting with pwntools</span>
</span></span><span style=display:flex><span>nc <span style=color:#f92672>=</span> remote(<span style=color:#e6db74>&#39;crypto.2021.chall.actf.co&#39;</span>, <span style=color:#ae81ff>21601</span>)
</span></span><span style=display:flex><span>nc<span style=color:#f92672>.</span>recvline()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nums <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> i <span style=color:#f92672>in</span> range(<span style=color:#ae81ff>100</span>):
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Sending the numbers from 0-99 to the server and listening to the response</span>
</span></span><span style=display:flex><span>    nc<span style=color:#f92672>.</span>sendline(str(i))
</span></span><span style=display:flex><span>    res <span style=color:#f92672>=</span> str(nc<span style=color:#f92672>.</span>recvline())
</span></span><span style=display:flex><span>    <span style=color:#75715e># Stripping the number from the response and appending it to numbers</span>
</span></span><span style=display:flex><span>    nums<span style=color:#f92672>.</span>append(int(re<span style=color:#f92672>.</span>findall(<span style=color:#e6db74>&#34;[0-9]+&#34;</span>, res)[<span style=color:#ae81ff>0</span>]))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Using sagemaths to solve the linear system</span>
</span></span><span style=display:flex><span>M <span style=color:#f92672>=</span> matrix(ZZ, <span style=color:#ae81ff>100</span>, <span style=color:#ae81ff>100</span>, <span style=color:#66d9ef>lambda</span> x, y: pow(x, <span style=color:#ae81ff>99</span><span style=color:#f92672>-</span>y))
</span></span><span style=display:flex><span>b <span style=color:#f92672>=</span> vector(GF(<span style=color:#ae81ff>691</span>), <span style=color:#ae81ff>100</span>, nums)
</span></span><span style=display:flex><span>solution <span style=color:#f92672>=</span> M<span style=color:#f92672>.</span>solve_right(b)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Converting the solution into a string</span>
</span></span><span style=display:flex><span>flag <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span><span style=color:#f92672>.</span>join(chr(c) <span style=color:#66d9ef>for</span> c <span style=color:#f92672>in</span> solution)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>print(flag)
</span></span></code></pre></div><p>Sure enough, after a minute or so of running, we get the flag!</p><p><em>actf{polynomials_20a829322766642530cf69}</em></p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.adelaideb9.com/>AdelaideB9 Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>